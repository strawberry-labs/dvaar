# =============================================================================
# Dvaar Caddy Configuration
# BASE_DOMAIN: dvaar.io (main site on Vercel, API/admin/dash on this server)
# TUNNEL_DOMAIN: dvaar.app (user tunnel URLs)
# =============================================================================

# Global options - enable on-demand TLS for tunnel subdomains
{
    on_demand_tls {
        ask http://dvaar:8080/_caddy/check
    }
}

# API endpoint (api.dvaar.io)
api.{$BASE_DOMAIN:dvaar.io} {
    reverse_proxy dvaar:8080
}

# Admin panel (admin.dvaar.io)
admin.{$BASE_DOMAIN:dvaar.io} {
    reverse_proxy dvaar:8080
}

# User dashboard (dash.dvaar.io)
dash.{$BASE_DOMAIN:dvaar.io} {
    reverse_proxy dvaar:8080
}

# On-demand TLS for tunnel subdomains (*.dvaar.app)
# Certs are provisioned per-subdomain using HTTP-01 challenge
https://*.{$TUNNEL_DOMAIN:dvaar.app} {
    tls {
        on_demand
    }
    reverse_proxy dvaar:8080
}

# Root tunnel domain redirect (dvaar.app -> dvaar.io)
{$TUNNEL_DOMAIN:dvaar.app} {
    redir https://{$BASE_DOMAIN:dvaar.io}{uri} permanent
}
